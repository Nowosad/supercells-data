---
title: "Poland Tmax Monthly: Supercells Workflow"
---

<!--
idea notes: do not remove
- dtw distance
- maybe merge
- main ideas presented:
- compare euclidean and dtw distances on monthly temperature profiles
- assess the effect of layer scaling for dtw-based segmentation
- evaluate boundaries and compact global metrics across runs
-->

```{r setup}
library(terra)
library(sf)
library(supercells)
```

## Load input data

```{r read-data}
tmax <- rast("data/poland_tmax_monthly.tif")
tmax
```

## Prepare a scaled temperature stack

```{r preprocess}
tmax_scaled <- scale(tmax)
tmax_scaled
```

## Preview raw vs scaled data

```{r plot-data}
#| fig-width: 12
#| fig-height: 6
#| layout-ncol: 1
panel(tmax[[c(1, 7)]], main = c("Raw: Jan", "Raw: Jul"))
panel(tmax_scaled[[c(1, 7)]], main = c("Scaled: Jan", "Scaled: Jul"))
```

## Tune compactness for Euclidean (raw vs scaled)

```{r tune-compactness-euclidean}
step_size <- 50

tune_euclidean_raw <- sc_tune_compactness(
  tmax,
  step = step_size,
  metric = "local",
  dist_fun = "euclidean"
)
tune_euclidean_scaled <- sc_tune_compactness(
  tmax_scaled,
  step = step_size,
  metric = "local",
  dist_fun = "euclidean"
)

tune_tbl <- data.frame(
  run = c("euclidean_raw", "euclidean_scaled"),
  compactness = c(
    tune_euclidean_raw$compactness[[1]],
    tune_euclidean_scaled$compactness[[1]]
  )
)
tune_tbl
```

## Build Euclidean supercells (raw vs scaled)

```{r build-euclidean}
sc_euclidean_raw <- sc_slic(
  tmax,
  step = step_size,
  compactness = tune_euclidean_raw$compactness[[1]],
  dist_fun = "euclidean",
  outcomes = c("supercells", "values")
)
sc_euclidean_scaled <- sc_slic(
  tmax_scaled,
  step = step_size,
  compactness = tune_euclidean_scaled$compactness[[1]],
  dist_fun = "euclidean",
  outcomes = c("supercells", "values")
)

cat("Euclidean (raw) supercells:", nrow(sc_euclidean_raw), "\n")
cat("Euclidean (scaled) supercells:", nrow(sc_euclidean_scaled), "\n")
```

## Plot January boundaries (Euclidean raw vs scaled)

```{r plot-euclidean-boundaries}
#| fig-width: 9
#| fig-height: 10
#| layout-ncol: 1
plot(tmax[[1]], main = "Euclidean on raw")
plot(st_geometry(sc_euclidean_raw), add = TRUE, border = "red", lwd = 0.5)

plot(tmax_scaled[[1]], main = "Euclidean on scaled")
plot(st_geometry(sc_euclidean_scaled), add = TRUE, border = "cyan", lwd = 0.5)
```

## Compare Euclidean global metrics (raw vs scaled)

```{r compare-euclidean-metrics}
metrics_euclidean <- rbind(
  transform(sc_metrics_global(tmax, sc_euclidean_raw), run = "euclidean_raw"),
  transform(sc_metrics_global(tmax_scaled, sc_euclidean_scaled), run = "euclidean_scaled")
)
metrics_euclidean
```

## Compare Euclidean pixel metrics (raw vs scaled)

```{r plot-euclidean-pixel-metrics}
#| fig-width: 12
#| fig-height: 10
#| layout-ncol: 3
pix_euclidean_raw <- sc_metrics_pixels(
  tmax,
  sc_euclidean_raw,
  metrics = c("spatial", "value", "balance")
)
pix_euclidean_scaled <- sc_metrics_pixels(
  tmax_scaled,
  sc_euclidean_scaled,
  metrics = c("spatial", "value", "balance")
)

plot(pix_euclidean_raw[[1]], main = "Euclidean raw: spatial")
plot(pix_euclidean_raw[[2]], main = "Euclidean raw: value")
plot(pix_euclidean_raw[[3]], main = "Euclidean raw: balance")
plot(pix_euclidean_scaled[[1]], main = "Euclidean scaled: spatial")
plot(pix_euclidean_scaled[[2]], main = "Euclidean scaled: value")
plot(pix_euclidean_scaled[[3]], main = "Euclidean scaled: balance")
```

## Compare Euclidean supercell metrics (raw vs scaled)

```{r plot-euclidean-supercell-metrics}
#| fig-width: 12
#| fig-height: 10
#| layout-ncol: 3
sc_euclidean_metrics_raw <- sc_metrics_supercells(tmax, sc_euclidean_raw)
sc_euclidean_metrics_scaled <- sc_metrics_supercells(tmax_scaled, sc_euclidean_scaled)

plot(sc_euclidean_metrics_raw["mean_spatial_dist_scaled"], main = "Euclidean raw: mean spatial")
plot(sc_euclidean_metrics_raw["mean_value_dist_scaled"], main = "Euclidean raw: mean value")
plot(sc_euclidean_metrics_raw["balance"], main = "Euclidean raw: balance")
plot(sc_euclidean_metrics_scaled["mean_spatial_dist_scaled"], main = "Euclidean scaled: mean spatial")
plot(sc_euclidean_metrics_scaled["mean_value_dist_scaled"], main = "Euclidean scaled: mean value")
plot(sc_euclidean_metrics_scaled["balance"], main = "Euclidean scaled: balance")
```

## Tune compactness for DTW (raw)

```{r tune-compactness-dtw}
tune_dtw_raw <- sc_tune_compactness(
  tmax,
  step = step_size,
  metric = "local",
  dist_fun = "dtw"
)
```

## Build DTW supercells (raw)

```{r build-dtw}
sc_dtw_raw <- sc_slic(
  tmax,
  step = step_size,
  compactness = tune_dtw_raw$compactness[[1]],
  dist_fun = "dtw",
  outcomes = c("supercells", "values")
)

cat("DTW (raw) supercells:", nrow(sc_dtw_raw), "\n")
```

## Plot January boundaries (Euclidean vs DTW on raw)

```{r plot-dtw-boundaries}
#| fig-width: 9
#| fig-height: 10
#| layout-ncol: 1
plot(tmax[[1]], main = "Euclidean on raw")
plot(st_geometry(sc_euclidean_raw), add = TRUE, border = "red", lwd = 0.5)

plot(tmax[[1]], main = "DTW on raw")
plot(st_geometry(sc_dtw_raw), add = TRUE, border = "yellow", lwd = 0.5)
```

## Compare Euclidean vs DTW metrics (raw)

```{r compare-dtw-metrics}
metrics_raw <- rbind(
  transform(sc_metrics_global(tmax, sc_euclidean_raw), run = "euclidean_raw"),
  transform(sc_metrics_global(tmax, sc_dtw_raw), run = "dtw_raw")
)
metrics_raw
```

## Compare Euclidean vs DTW pixel metrics (raw)

```{r plot-dtw-pixel-metrics}
#| fig-width: 12
#| fig-height: 10
#| layout-ncol: 3
pix_dtw <- sc_metrics_pixels(
  tmax,
  sc_dtw_raw,
  metrics = c("spatial", "value", "balance")
)

plot(pix_euclidean_raw[[1]], main = "Euclidean raw: spatial")
plot(pix_euclidean_raw[[2]], main = "Euclidean raw: value")
plot(pix_euclidean_raw[[3]], main = "Euclidean raw: balance")
plot(pix_dtw[[1]], main = "DTW raw: spatial")
plot(pix_dtw[[2]], main = "DTW raw: value")
plot(pix_dtw[[3]], main = "DTW raw: balance")
```

## Compare Euclidean vs DTW supercell metrics (raw)

```{r plot-dtw-supercell-metrics}
#| fig-width: 12
#| fig-height: 10
#| layout-ncol: 3
sc_dtw_metrics <- sc_metrics_supercells(tmax, sc_dtw_raw)

plot(sc_euclidean_metrics_raw["mean_spatial_dist_scaled"], main = "Euclidean raw: mean spatial")
plot(sc_euclidean_metrics_raw["mean_value_dist_scaled"], main = "Euclidean raw: mean value")
plot(sc_euclidean_metrics_raw["balance"], main = "Euclidean raw: balance")
plot(sc_dtw_metrics["mean_spatial_dist_scaled"], main = "DTW raw: mean spatial")
plot(sc_dtw_metrics["mean_value_dist_scaled"], main = "DTW raw: mean value")
plot(sc_dtw_metrics["balance"], main = "DTW raw: balance")
```
