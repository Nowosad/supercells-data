---
title: "Poland EVI 2020 Bimonthly: Supercells Workflow"
format: html
execute:
  warning: false
  message: false
---

<!--
idea notes: do not remove
- show map_units
- this dataset has many NA values (outside valid area/masked regions)
- main ideas presented:
- use map-unit step sizes (50 km and 30 km) for segmentation scale control
- compare tuned and auto compactness at fixed 30 km scale
- evaluate both scale and compactness effects with concise metrics
-->

```{r setup}
library(terra)
library(sf)
library(supercells)
```

## Load input data

```{r read-data}
evi <- rast("data/poland_evi_2020_bimonthly.tif")
evi
panel(evi)
```

## Tune compactness at two scales

```{r tune-compactness}
step_50km <- in_meters(50000)
step_30km <- in_meters(30000)

tune_50km <- sc_tune_compactness(
  evi,
  step = step_50km,
  metrics = "local"
)
tune_30km <- sc_tune_compactness(
  evi,
  step = step_30km,
  metrics = "local"
)

tune_tbl <- rbind(tune_50km, tune_30km)
tune_tbl
```

## Build supercells

```{r build-supercells}
sc_50km <- sc_slic(
  evi,
  step = step_50km,
  compactness = tune_50km$compactness[[1]],
  outcomes = c("supercells", "values")
)
sc_30km <- sc_slic(
  evi,
  step = step_30km,
  compactness = tune_30km$compactness[[1]],
  outcomes = c("supercells", "values")
)
sc_30km_auto <- sc_slic(
  evi,
  step = step_30km,
  compactness = "auto",
  outcomes = c("supercells", "values")
)
cat("50 km supercells:", nrow(sc_50km), "\n")
cat("30 km supercells (tuned):", nrow(sc_30km), "\n")
cat("30 km supercells (auto):", nrow(sc_30km_auto), "\n")
```

## Plot first EVI layer with boundaries

```{r plot-boundaries, fig.width=12, fig.height=5}
par(mfrow = c(1, 2), mar = c(3, 3, 2, 1))

plot(evi[[1]], main = "50 km step (map units)")
plot(st_geometry(sc_50km), add = TRUE, border = "red", lwd = 0.6)

plot(evi[[1]], main = "30 km step (tuned compactness)")
plot(st_geometry(sc_30km), add = TRUE, border = "yellow", lwd = 0.6)
```

## Plot 30 km tuned versus auto compactness

```{r plot-compactness, fig.width=12, fig.height=5}
par(mfrow = c(1, 2), mar = c(3, 3, 2, 1))

plot(evi[[1]], main = "30 km tuned compactness")
plot(st_geometry(sc_30km), add = TRUE, border = "yellow", lwd = 0.6)

plot(evi[[1]], main = "30 km auto compactness")
plot(st_geometry(sc_30km_auto), add = TRUE, border = "cyan", lwd = 0.6)
```

## Compare global metrics for scale (tuned compactness)

```{r compare-scale-metrics}
sc_metrics_50km <- sc_metrics_global(evi, sc_50km)
sc_metrics_30km <- sc_metrics_global(evi, sc_30km)
metrics_scale <- rbind(
  transform(sc_metrics_50km, run = "50km_tuned"),
  transform(sc_metrics_30km, run = "30km_tuned")
)
metrics_scale
```

## Compare global metrics for compactness (30 km)

```{r compare-compactness-metrics}
sc_metrics_30km_auto <- sc_metrics_global(evi, sc_30km_auto)
metrics_compactness <- rbind(
  transform(sc_metrics_30km, run = "30km_tuned"),
  transform(sc_metrics_30km_auto, run = "30km_auto")
)
metrics_compactness
```

